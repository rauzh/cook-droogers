swagger: '2.0'
info:
  version: 1.0.0
  title: Swagger-Cook-Droogers
host: 0.0.0.0:13337
basePath: /api
tags:
  - name: artists
  - name: managers
  - name: users
  - name: requests
  - name: tracks
  - name: releases
  - name: auth

securityDefinitions:
  JWTAuth:
    type: apiKey
    in: header
    name: access_token

schemes:
  - http
paths:

  # =================== REQUESTS ===================

  /requests:
    get:
      summary: Get requests
      tags:
        - requests
      security:
        - JWTAuth: [ ]
      operationId: getRequests
      responses:
        200:
          description: Success
          schema:
            type: array
            items:
              $ref: '#/definitions/RequestDTO'
        401:
          description: Auth error
        403:
          description: Invalid user type
        500:
          description: Internal error

  /requests/{req_id}:
    get:
      summary: Get specified request
      tags:
        - requests
      security:
        - JWTAuth: [ ]
      operationId: getRequest
      parameters:
        - in: path
          name: req_id
          required: true
          type: integer
          format: uint64
          description: "ID заявки"
      responses:
        200:
          description: Success
          schema:
            $ref: '#/definitions/PublishRequestDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such request
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  # =================== ARTIST ====================

  /artists/{id}:
    get:
      summary: Get artist data
      tags:
        - artists
      security:
        - JWTAuth: [ ]
      operationId: getArtistByID
      parameters:
        - in: path
          name: id
          required: true
          type: integer
          format: uint64
          description: "ID"
        - in: query
          name: by_user_id
          type: boolean
          default: false
          description: "Использовать ли user_id вместо artist_id"

      responses:
        200:
          description: Success
          schema:
            $ref: '#/definitions/ArtistDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such artist
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  # =================== REQUESTS ====================

  /requests/publications:
    post:
      summary: Create publish request
      security:
        - JWTAuth: [ ]
      tags:
        - requests
      operationId: publishReq
      consumes:
        - application/json
      parameters:
        - in: body
          name: publication_info
          description: "Поля заявки на публикацию релиза"
          required: true
          schema:
            $ref: '#/definitions/CreatePublishRequestDTO'
      responses:
        201:
          description: Request successfully created
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /releases:

    get:
      summary: Get releases
      security:
        - JWTAuth: [ ]
      tags:
        - releases
      operationId: getRelease
      consumes:
        - application/json
      responses:
        200:
          description: Success
          schema:
            type: array
            items:
              $ref: '#/definitions/ReleaseDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

    post:
      summary: Upload release
      security:
        - JWTAuth: [ ]
      tags:
        - releases
      operationId: addRelease
      consumes:
        - application/json
      parameters:
        - in: body
          name: release
          description: "Информация о релизе"
          required: true
          schema:
            $ref: '#/definitions/UploadReleaseDTO'
      responses:
        201:
          description: Request successfully created
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /releases/{release_id}:
    get:
      summary: Get release data
      tags:
        - releases
      security:
        - JWTAuth: [ ]
      operationId: getReleaseByID
      parameters:
        - in: path
          name: release_id
          required: true
          type: integer
          format: uint64
          description: "ID релиза"
      responses:
        200:
          description: Success
          schema:
            $ref: '#/definitions/ReleaseDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such release
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /tracks/{track_id}:
    get:
      summary: Get track data
      tags:
        - tracks
      security:
        - JWTAuth: [ ]
      operationId: getTrackByID
      parameters:
        - in: path
          name: track_id
          required: true
          type: integer
          format: uint64
          description: "ID трека"
      responses:
        200:
          description: Success
          schema:
            $ref: '#/definitions/TrackDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such track
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  # =================== MANAGER ===================

  /managers/{manager_id}:
    get:
      summary: Get manager data
      tags:
        - managers
      security:
        - JWTAuth: [ ]
      operationId: getManagerByID
      parameters:
        - in: path
          name: manager_id
          required: true
          type: integer
          format: uint64
          description: "ID менеджера"
      responses:
        200:
          description: Success
          schema:
            $ref: '#/definitions/ManagerDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such manager
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /requests/{req_id}/accept:
    patch:
      summary: Accept specified request
      tags:
        - requests
      security:
        - JWTAuth: [ ]
      operationId: acceptRequest
      parameters:
        - in: path
          name: req_id
          required: true
          type: integer
          format: uint64
          description: "ID заявки"
      responses:
        200:
          description: Success
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type (or this manager is not maintainer of the request)
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such request
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /requests/{req_id}/decline:
    patch:
      summary: Decline specified request
      tags:
        - requests
      security:
        - JWTAuth: [ ]
      operationId: declineRequest
      parameters:
        - in: path
          name: req_id
          required: true
          type: integer
          format: uint64
          description: "ID заявки"
      responses:
        200:
          description: Success
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type (or this manager is not maintainer of the request)
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such request
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  # ================== NON-MEMBER ==================

  /users/{user_id}:
    get:
      summary: Get user data by id
      tags:
        - users
      security:
        - JWTAuth: [ ]
      operationId: getUserByID
      parameters:
        - in: path
          name: user_id
          required: true
          type: integer
          format: uint64
          description: "ID юзера"
      responses:
        200:
          description: Success
          schema:
            $ref: '#/definitions/UserDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Forbidden
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such user
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /requests/contracts:
    post:
      summary: Create sign request
      security:
        - JWTAuth: [ ]
      tags:
        - requests
      operationId: signContract
      consumes:
        - application/json
      parameters:
        - in: body
          name: signRequest
          description: "Информация для запроса на подписание контракта"
          required: true
          schema:
            $ref: '#/definitions/CreateSignRequestDTO'
      responses:
        201:
          description: Request successfully created
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  # ================== ADMIN ==================

  /managers:
    get:
      summary: Get list of managers
      tags:
        - managers
      operationId: getManagers
      security:
        - JWTAuth: []
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        200:
          description: Success
          schema:
            type: array
            items:
              $ref: '#/definitions/ManagerDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'
    post:
      summary: Create managers
      tags:
        - managers
      operationId: addManagers
      security:
        - JWTAuth: [ ]
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: managersData
          description: "Данные для создания менеджеров"
          required: true
          schema:
            $ref: '#/definitions/CreateManagerDTO'
      responses:
        201:
          description: Manager successfully created
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: Invalid user type (your role)
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such user
          schema:
            $ref: '#/definitions/LeErrorMessage'
        409:
          description: Already exists
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /users:
    get:
      summary: Get list of users
      tags:
        - users
      operationId: getUsers
      security:
        - JWTAuth: [ ]
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        200:
          description: Success
          schema:
            type: array
            items:
              $ref: '#/definitions/UserDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        403:
          description: No rights
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  # ================== GUEST ==================
  /register:
    post:
      summary: Create new user
      tags:
        - auth
      operationId: register
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: userData
          description: "Данные для регистрации нового пользователя"
          required: true
          schema:
            $ref: '#/definitions/RegisterUserDTO'
      responses:
        201:
          description: User successfully created
          schema:
            $ref: '#/definitions/AccessTokenDTO'
        409:
          description: User already exists
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  /login:
    post:
      summary: Login, lol
      tags:
        - auth
      operationId: login
      consumes:
        - application/json
      produces:
        - application/json
      parameters:
        - in: body
          name: loginData
          description: "Данные для входа"
          required: true
          schema:
            $ref: '#/definitions/LoginUserDTO'
      responses:
        200:
          description: User successfully logged in
          schema:
            $ref: '#/definitions/AccessTokenDTO'
        401:
          description: Auth error
          schema:
            $ref: '#/definitions/LeErrorMessage'
        404:
          description: No such user
          schema:
            $ref: '#/definitions/LeErrorMessage'
        422:
          description: Invalid params
          schema:
            $ref: '#/definitions/LeErrorMessage'
        500:
          description: Internal error
          schema:
            $ref: '#/definitions/LeErrorMessage'

  # ================== ALL ==================

  /heartbeat:
    get:
      summary: Check health
      responses:
        200:
          description: Success

definitions:

  RegUserDTO:
    type: object
    required:
      - name
      - email
      - password
    properties:
      name:
        type: string
      email:
        type: string
        format: email
      password:
        type: string

  UserDTO:
    type: object
    properties:
      user_id:
        type: integer
        format: uint64
      name:
        type: string
      email:
        type: string
        format: email
      password:
        type: string
      type:
        type: integer
        enum:
          - 0  # NonMemberUser
          - 1  # ManagerUser
          - 2  # ArtistUser
          - 3  # Admin

  ArtistDTO:
    type: object
    properties:
      artist_id:
        type: integer
        format: uint64
      user_id:
        type: integer
        format: uint64
      manager_id:
        type: integer
        format: uint64
      nickname:
        type: string
      activity:
        type: boolean
      contract_term:
        type: string
        format: date

  ManagerDTO:
    type: object
    properties:
      manager_id:
        type: integer
        format: uint64
      user_id:
        type: integer
        format: uint64
      artists:
        type: array
        items:
          type: integer
          format: uint64

  StatsDTO:
    type: object
    properties:
      stat_id:
        type: integer
        format: uint64
      date:
        type: string
        format: date
      streams:
        type: integer
        format: uint64
      likes:
        type: integer
        format: uint64
      track_id:
        type: integer
        format: uint64

  TrackDTO:
    type: object
    required:
      - title
      - duration
      - genre
      - type
    properties:
      track_id:
        type: integer
        format: uint64
      title:
        type: string
      duration:
        type: integer
        format: uint64
      genre:
        type: string
      type:
        type: string
      artists:
        type: array
        items:
          type: integer
          format: uint64

  ReleaseDTO:
    type: object
    properties:
      release_id:
        type: integer
        format: uint64
      title:
        type: string
      status:
        type: string
        enum:
          - Unpublished
          - Published
      date_creation:
        type: string
        format: date
      tracks:
        type: array
        items:
          type: integer
          format: uint64
      artist_id:
        type: integer
        format: uint64

  RequestDTO:
    type: object
    properties:
      request_id:
        type: integer
        format: uint64
      type:
        type: string
        enum:
          - Publish
          - Sign
      status:
        type: string
        enum:
          - New
          - Processing
          - On approval
          - Closed
      date:
        type: string
        format: date
      applier_id:
        type: integer
        format: uint64
      manager_id:
        type: integer
        format: uint64

  PublishRequestDTO:
    type: object
    properties:
      base:
        $ref: '#/definitions/RequestDTO'
      release_id:
        type: integer
        format: uint64
      grade:
        type: integer
      expected_date:
        type: string
        format: date
      description:
        type: string

  SignRequestDTO:
    type: object
    properties:
      base:
        $ref: '#/definitions/RequestDTO'
      nickname:
        type: string
      description:
        type: string

  UploadReleaseDTO:
    type: object
    properties:
      title:
        type: string
        description: "Название релиза"
      date:
        type: string
        format: date
        description: "Дата написания релиза"
      tracks:
        type: array
        description: "Треки данного релиза"
        items:
          $ref: '#/definitions/TrackDTO'
    required:
      - title
      - date
      - tracks

  CreateManagerDTO:
    type: object
    properties:
      user_id:
        type: array
        items:
          type: integer
          format: uint64
        description: "ID пользователя"
    required:
      - user_id

  CreateSignRequestDTO:
    type: object
    properties:
      nickname:
        type: string
        description: "Псевдоним"
    required:
      - nickname

  CreatePublishRequestDTO:
    type: object
    properties:
      release_id:
        type: integer
        format: uint64
      expected_date:
        type: string
        format: date

  RegisterUserDTO:
    type: object
    properties:
      username:
        type: string
        description: "Имя пользователя"
      email:
        type: string
        format: email
        description: "Email пользователя"
      password:
        type: string
        description: "Пароль пользователя"
    required:
      - username
      - email
      - password

  LoginUserDTO:
    type: object
    properties:
      email:
        type: string
        format: email
        description: "Email пользователя"
      password:
        type: string
        format: password
        description: "Пароль пользователя"
    required:
      - email
      - password

  AccessTokenDTO:
    type: object
    properties:
      access_key:
        type: string
        description: "JWT access key"

  LeErrorMessage:
    type: object
    properties:
      error:
        type: string

responses:
  UnauthorizedError:
    description: Authentication information is missing or invalid
    headers:
      WWW_Authenticate:
        type: string